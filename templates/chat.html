<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat - {{ tarea.titulo }}</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/ios.css') }}">

<style>

/* ===== CONTENEDOR GENERAL ===== */

body{
    margin:0;
    background:#f2f2f7;
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
}

.chat-wrapper{
    display:flex;
    flex-direction:column;
    height:100vh;
}

/* ===== HEADER ===== */

.chat-header{
    background:rgba(255,255,255,0.8);
    backdrop-filter:blur(20px);
    padding:15px;
    text-align:center;
    font-weight:600;
    border-bottom:1px solid #ddd;
}

/* ===== MENSAJES ===== */

.chat-box{
    flex:1;
    overflow-y:auto;
    padding:15px;
}

/* MENSAJE */

.mensaje{
    max-width:75%;
    padding:10px 14px;
    margin:6px 0;
    border-radius:18px;
    font-size:15px;
    word-wrap:break-word;
}

/* USUARIO */

.usuario{
    background:#007aff;
    color:white;
    margin-left:auto;
    border-bottom-right-radius:4px;
}

/* OTRO */

.otro{
    background:#e5e5ea;
    color:black;
    margin-right:auto;
    border-bottom-left-radius:4px;
}

/* HORA */

.hora{
    font-size:11px;
    opacity:0.6;
    margin-top:3px;
}

/* IMAGEN */

.chat-img{
    max-width:200px;
    border-radius:10px;
    margin-top:5px;
}

/* ARCHIVO */

.archivo{
    display:block;
    margin-top:5px;
    color:#007aff;
    text-decoration:none;
}

/* ===== INPUT IOS ===== */

.chat-input-container{
    padding:10px;
    background:rgba(255,255,255,0.8);
    backdrop-filter:blur(20px);
}

.ios-input-bar{

    display:flex;
    align-items:center;
    gap:10px;

    padding:8px 12px;

    background:rgba(240,240,245,0.8);

    border-radius:25px;
}

/* INPUT TEXTO */

.ios-input-bar input[type="text"]{

    flex:1;

    border:none;
    outline:none;

    background:transparent;

    font-size:16px;
}

/* ICONOS */

.icon-btn{

    background:none;
    border:none;

    font-size:20px;

    cursor:pointer;
}

/* BOTON ENVIAR */

.send-btn{

    background:#007aff;
    color:white;

    border:none;

    width:34px;
    height:34px;

    border-radius:50%;

    cursor:pointer;

    font-size:16px;
}

</style>

</head>
<body>

<div class="chat-wrapper">

    <!-- HEADER -->
    <div class="chat-header">
        {{ tarea.titulo }}
    </div>

    <!-- MENSAJES -->
    <div class="chat-box" id="chatBox"></div>

    <!-- INPUT -->
    <div class="chat-input-container">

        <form id="formChat" class="ios-input-bar" enctype="multipart/form-data">

            <button type="button" class="icon-btn">
                ðŸ˜Š
            </button>

            <input
                type="text"
                name="mensaje"
                id="mensaje"
                placeholder="Mensaje"
            >

            <label class="icon-btn">
                ðŸ“Ž
                <input type="file" name="archivo" id="archivo" hidden>
            </label>

            <button type="submit" class="send-btn">
                â†‘
            </button>

        </form>

    </div>

</div>

<script>

const chatBox = document.getElementById("chatBox");


// ===== CARGAR MENSAJES =====

async function cargarMensajes(){

    const res = await fetch("{{ url_for('obtener_mensajes', tarea_id=tarea._id) }}");

    const mensajes = await res.json();

    chatBox.innerHTML = "";

    mensajes.forEach(m => {

        const div = document.createElement("div");

        div.className =
            "mensaje " +
            (m.usuario === "{{ session.usuario }}" ? "usuario" : "otro");


        if(m.texto){

            const texto = document.createElement("div");
            texto.innerText = m.texto;

            div.appendChild(texto);
        }


        if(m.archivo){

            if(m.archivo.tipo.startsWith("image")){

                const img = document.createElement("img");

                img.src = m.archivo.url;

                img.className = "chat-img";

                div.appendChild(img);

            }else{

                const link = document.createElement("a");

                link.href = m.archivo.url;

                link.className = "archivo";

                link.innerText = "ðŸ“Ž " + m.archivo.nombre;

                div.appendChild(link);
            }
        }


        const hora = document.createElement("div");

        hora.className = "hora";

        hora.innerText = m.fecha;

        div.appendChild(hora);


        chatBox.appendChild(div);

    });


    // scroll abajo
    chatBox.scrollTop = chatBox.scrollHeight;
}



// ===== ENVIAR MENSAJE =====

document.getElementById("formChat")
.addEventListener("submit", async function(e){

    e.preventDefault();

    const formData = new FormData(this);

    await fetch(
        "{{ url_for('enviar_mensaje', tarea_id=tarea._id) }}",
        {
            method:"POST",
            body:formData
        }
    );

    this.reset();

    cargarMensajes();

});



// ===== AUTO ACTUALIZAR =====

setInterval(cargarMensajes, 2000);


// cargar al inicio

cargarMensajes();


</script>

</body>
</html>